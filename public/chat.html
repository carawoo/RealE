<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RealE - ë¶€ë™ì‚° AI ìƒë‹´</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f0f23;height:100vh;overflow:hidden;color:#e5e7eb}
    .chat-container{height:100vh;display:flex;flex-direction:column;position:relative}
    .chat-messages{flex:1;overflow-y:auto;padding:32px 16px 88px}
    .messages-container{max-width:768px;margin:0 auto}
    .message{margin:12px 0;display:flex;gap:10px}
    .message.user{justify-content:flex-end}
    /* âœ… ë§í’ì„  ìµœì†Œ ë„ˆë¹„ 50vw ë³´ì¥ + ì¤„ë°”ê¿ˆ ê°œì„  */
    .message .bubble{
      display:inline-block;                 /* ë‚´ìš© ê¸¸ì´ì— ë§ì¶”ë˜â€¦   */
      max-width:80%;                        /* ì»¨í…Œì´ë„ˆì˜ 80%ë¥¼ ìƒí•œ  */
      min-width:min(50vw, 80%);             /* í™”ë©´ 50%ë¥¼ í•˜í•œ(ì»¨í…Œì´ë„ˆ ì´ë‚´) */
      border-radius:14px;
      padding:14px 16px;
      line-height:1.6;
      overflow-wrap:anywhere;               /* ê¸´ ìˆ«ì/URLë„ ì¤„ë°”ê¿ˆ   */
      word-break:keep-all;                  /* í•œê¸€ ë‹¨ì–´ëŠ” ê°€ê¸‰ì  ë³´ì¡´ */
    }
    .message.user .bubble{background:linear-gradient(135deg,#1f2a44,#26334f);border:1px solid #2f3b5a}
    .message.assistant .bubble{background:#1f2937;border:1px solid #374151}
    .chips{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#2a3551;border:1px solid #3a4a76;color:#e3e7ff;border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer}
    .chip:hover{background:#334065}
    .chip.alt{background:#243042;border-color:#3a4a76}
    .chip.ghost{background:transparent;border-color:#4b5563;color:#cbd5e1}
    .small{opacity:.8;font-size:13px}
    .chat-input-container{position:fixed;left:0;right:0;bottom:0;background:#1f2937;border-top:1px solid #374151;padding:14px 16px}
    .input-row{max-width:768px;margin:0 auto;display:flex;gap:12px;align-items:stretch}
    .input-wrapper{flex:1;position:relative;background:#374151;border:1px solid #4b5563;border-radius:12px;display:flex;align-items:center}
    .input-wrapper:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.2)}
    textarea{width:100%;min-height:44px;max-height:120px;padding:12px 48px 12px 14px;border:none;border-radius:12px;background:transparent;color:#f9fafb;resize:none;outline:none;font-size:16px}
    .send-button{width:48px;border:none;border-radius:14px;background:linear-gradient(135deg,#8b5cf6,#06b6d4);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(100,116,255,.25);cursor:pointer;padding:0 0}
    .send-button:disabled{opacity:.5;cursor:not-allowed}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .typing{display:flex;gap:6px;margin-top:8px}
    .dot{width:6px;height:6px;background:#8b5cf6;border-radius:50%;opacity:.5;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <div class="messages-container" id="msgs"></div>
    </div>

    <div class="chat-input-container">
      <div class="input-row">
        <div class="input-wrapper">
          <textarea id="messageInput" placeholder="ê¶ê¸ˆí•œ ì ì€ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!" rows="1"></textarea>
        </div>
        <button class="send-button" id="sendButton">
          <i class="fas fa-arrow-up"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
  // ===== ê³µí†µ ìœ í‹¸ =====
  const $msgs = document.getElementById('msgs');
  const $input = document.getElementById('messageInput');
  const $send = document.getElementById('sendButton');

  function scrollToBottom(){ requestAnimationFrame(()=>{ const wrap=document.getElementById('chatMessages'); wrap.scrollTop = wrap.scrollHeight; }); }
  function userBubble(html){ const el=document.createElement('div'); el.className='message user'; el.innerHTML=`<div class="bubble">${html}</div>`; $msgs.appendChild(el); scrollToBottom(); }
  function botBubble(html){ const el=document.createElement('div'); el.className='message assistant'; el.innerHTML=`<div class="bubble">${html}</div>`; $msgs.appendChild(el); scrollToBottom(); return el.querySelector('.bubble'); }
  function typingDots(parent){ const box=document.createElement('div'); box.className='typing'; box.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>'; parent.appendChild(box); return ()=>box.remove(); }

  const KR = (n)=> new Intl.NumberFormat('ko-KR',{maximumFractionDigits:0}).format(+n||0);

  // ===== API ì—°ë™ =====
  async function callApi(message){
    const res = await fetch('/api/compute',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message })
    });
    if(!res.ok){ throw new Error('API '+res.status); }
    return await res.json(); // { reply, cards, checklist, notices }
  }

  // ê²°ê³¼ ì¹´ë“œ ë Œë”(ê¸°ì¡´ í•¨ìˆ˜ ì—†ìœ¼ë©´ ì—¬ê¸°ì— ë‚´ì¥)
  function renderResult(resp){
    const wrap = document.createElement('div');
    wrap.className = 'message assistant';
    const inner = document.createElement('div');
    inner.className = 'bubble';
    let html = '';
    (resp.cards||[]).forEach(c=>{
      html += `
        <div style="background:#111827;border:1px solid #374151;border-radius:12px;padding:14px 14px;margin:10px 0;">
          <div style="font-weight:700;margin-bottom:4px">${c.title||''}</div>
          <div class="small" style="margin-bottom:8px">${c.subtitle||''}</div>
          ${c.monthly?`<div style="font-size:22px;font-weight:800;margin:4px 0">${c.monthly}</div>`:''}
          ${c.totalInterest?`<div class="small" style="margin-bottom:8px">ì´ ì´ì: ${c.totalInterest}</div>`:''}
          ${Array.isArray(c.notes)?`<ul style="margin-left:16px">${c.notes.map(n=>`<li>${n}</li>`).join('')}</ul>`:''}
        </div>
      `;
    });
    if(Array.isArray(resp.checklist)&&resp.checklist.length){
      html += `
        <div style="background:#111827;border:1px solid #374151;border-radius:12px;padding:14px 14px;margin:10px 0;">
          <div style="font-weight:700;margin-bottom:8px">ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
          <ul style="margin-left:16px">${resp.checklist.map(n=>`<li>${n}</li>`).join('')}</ul>
        </div>
      `;
    }
    if(Array.isArray(resp.notices) && resp.notices.length){
      html += `<div class="small" style="opacity:.9;margin-top:6px">${resp.notices.join(' ')}</div>`;
    }
    inner.innerHTML = html || '<div class="small">í‘œì‹œí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    wrap.appendChild(inner);
    $msgs.appendChild(wrap);
    scrollToBottom();
  }

  // ===== ëŒ€í™”í˜• ìœ„ì €ë“œ =====
  const FLOW = {
    intent: { key:'ì˜ë„', prompt:'ì–´ë–¤ ìƒë‹´ì´ í•„ìš”í•˜ì„¸ìš”?', choices:['ë§¤ë§¤','ì „ì„¸','ì›”ì„¸'] },
    steps: {
      'ë§¤ë§¤': [
        { key:'ì˜ˆì‚°', unit:'ì–µ', choices:['3','4','5','6','7','8','10'] , required:true },
        { key:'ë³´ìœ ', unit:'ì²œ', choices:['3','5','8','10','15','20'] , required:true },
        { key:'ê¸°ê°„', unit:'ë…„', choices:['10','20','30'] , required:true },
        { key:'ìƒí™˜', choices:['ê³ ì •','ë³€ë™','ì²´ì¦ì‹'], required:false },
      ],
      'ì „ì„¸': [
        { key:'ì „ì„¸ê°€', unit:'ì–µ', choices:['2','3','4','5','6','7','8'] , required:true },
        { key:'ë³´ìœ ', unit:'ì²œ', choices:['1','2','3','5','8','10'] , required:true },
        { key:'ê¸°ê°„', unit:'ë…„', choices:['2','3','4'] , required:true },
      ],
      'ì›”ì„¸': [
        { key:'ë³´ì¦ê¸ˆ', unit:'ë§Œ', choices:['100','300','500','1000','2000','3000'] , required:true },
        { key:'ì›”ì„¸', unit:'ë§Œ', choices:['40','50','60','70','80','90','120'] , required:true },
        { key:'ê¸°ê°„', unit:'ë…„', choices:['1','2','3'] , required:true },
      ]
    }
  };

  const state = {
    active: true,
    intent: null,
    idx: -1,
    data: {},
    awaitingKey: null, // 'ì˜ˆì‚°' ë“± ì§ì ‘ì…ë ¥ ëŒ€ê¸°
  };

  function startWizard(){
    state.active = true; state.intent = null; state.idx = -1; state.data = {}; state.awaitingKey = null;
    askIntent();
  }

  function askIntent(){
    const b = botBubble(`<div style="font-weight:700">ë¹ ë¥´ê²Œ ì¶”ì²œì„ ì‹œì‘í• ê²Œìš”.</div>
      <div class="small" style="margin-top:6px">ë¨¼ì € ëª©ì ì„ ê³¨ë¼ ì£¼ì„¸ìš”.</div>`);
    renderChips(b, FLOW.intent.choices, (val)=>{
      userBubble(val);
      state.intent = val;
      askNext();
    }, { extraFree:true });
  }

  function askNext(){
    const steps = FLOW.steps[state.intent] || [];
    state.idx++;
    // ë‹¤ìŒ í•„ìˆ˜/ì„ í˜¸ ì§ˆë¬¸ì´ ì—†ìœ¼ë©´ ì™„ë£Œ
    if(state.idx >= steps.length){ return finishWizard(); }
    const step = steps[state.idx];
    const hint = step.unit ? `ì˜ˆ: ${step.choices?.[0] ?? ''}${step.unit}` : 'ìˆ«ì ë˜ëŠ” í…ìŠ¤íŠ¸';
    const b = botBubble(`<div style="font-weight:700">${step.key}ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div><div class="small" style="margin-top:6px">${hint}</div>`);
    renderChips(b, step.choices || [], (val)=>{
      const display = step.unit ? `${val}${step.unit}` : val;
      userBubble(`${step.key}: ${display}`);
      state.data[step.key] = String(val);
      askNext();
    }, { extraFree:true, key: step.key, unit: step.unit, optional: !step.required });
  }

  function finishWizard(){
    // ìš”ì•½ë¬¸ ìƒì„± â†’ API í˜¸ì¶œ
    const it = state.intent;
    const d = state.data;
    let msg = it;
    const add = (k, label=k)=>{
      if(d[k]) msg += `, ${label} ${d[k]}`;
    };

    if(it==='ë§¤ë§¤'){
      add('ì˜ˆì‚°'); add('ë³´ìœ '); add('ê¸°ê°„'); if(d['ìƒí™˜']) msg += `, ${d['ìƒí™˜']} ì„ í˜¸`;
    } else if(it==='ì „ì„¸'){
      add('ì „ì„¸ê°€'); add('ë³´ìœ '); add('ê¸°ê°„');
    } else if(it==='ì›”ì„¸'){
      // ë³´ì¦ê¸ˆ ìµœì†Œ 100 ë³´ì •(í”„ë¡ íŠ¸ UX)
      const dep = Math.max(100, parseInt(String(d['ë³´ì¦ê¸ˆ']||'0').replace(/\D/g,'' )||'0',10));
      const rent = parseInt(String(d['ì›”ì„¸']||'0').replace(/\D/g,'' )||'0',10);
      const years = d['ê¸°ê°„'] || '2';
      msg = `ì›”ì„¸, ë³´ì¦ê¸ˆ ${dep}ë§Œ, ì›”ì„¸ ${rent}ë§Œ, ${years}ë…„`;
    }

    userBubble(`<strong>ìš”ì•½</strong><br><span class="small">${msg}</span>`);
    runCompute(msg);
  }

  function renderChips(bubbleEl, choices, onPick, opts={}){
    const box = document.createElement('div'); box.className='chips';
    // ê¸°ë³¸ ì„ íƒì¹©
    choices.forEach(c=>{
      const btn=document.createElement('button'); btn.type='button';
      btn.className='chip'; btn.textContent=c;
      btn.onclick=()=>onPick(c);
      box.appendChild(btn);
    });
    // ì§ì ‘ ì…ë ¥
    if(opts.extraFree){
      const free=document.createElement('button'); free.type='button';
      free.className='chip ghost'; free.textContent='ì§ì ‘ ì…ë ¥';
      free.onclick=()=>{
        state.awaitingKey = opts.key || 'ì…ë ¥ê°’';
        $input.placeholder = opts.unit ? `${state.awaitingKey} ì…ë ¥ (ì˜ˆ: 6${opts.unit})` : `${state.awaitingKey} ì…ë ¥`;
        $input.focus();
      };
      box.appendChild(free);
    }
    // (ì„ íƒ) ì…ë ¥ ì•ˆí•¨ â€” ìš”ì²­í•˜ì‹  â€œì´ì „/ë‹¤ìŒ/ê±´ë„ˆë›°ê¸° ë²„íŠ¼â€ì€ ì œê±°í–ˆì§€ë§Œ,
    // ì˜µì…˜ ì§ˆë¬¸ì„ ë„˜ê¸°ê³  ì‹¶ì„ ë•Œë¥¼ ìœ„í•œ ì•„ì£¼ ì‘ì€ ì„ íƒì§€
    if(opts.optional){
      const skip=document.createElement('button'); skip.type='button';
      skip.className='chip alt'; skip.textContent='ì…ë ¥ ì•ˆí•¨';
      skip.onclick=()=>{ onPick(''); };
      box.appendChild(skip);
    }
    bubbleEl.appendChild(box);
    scrollToBottom();
  }

  // ===== ì „ì†¡/ì…ë ¥ ì²˜ë¦¬ =====
  function autoGrow(){
    $input.style.height='auto';
    $input.style.height=Math.min($input.scrollHeight,120)+'px';
  }
  $input.addEventListener('input', autoGrow);

  async function runCompute(summary){
    // ë²„íŠ¼ ìŠ¤í”¼ë„ˆ
    const prev = $send.innerHTML;
    $send.innerHTML = '<div class="spinner"></div>';
    $send.disabled = true;

    const host = botBubble('<div class="small">ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤â€¦</div>');
    const stop = typingDots(host);

    try{
      const resp = await callApi(summary);
      stop();
      if(resp.reply){ botBubble(resp.reply); }
      renderResult(resp);
    }catch(e){
      stop();
      botBubble('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      console.error(e);
    }finally{
      $send.innerHTML = prev;
      $send.disabled = false;
      scrollToBottom();
    }
  }

  // ì‚¬ìš©ìê°€ ì…ë ¥ì°½ìœ¼ë¡œ ë³´ë‚¼ ë•Œ:
  async function sendMessage(){
    const text = $input.value.trim();
    if(!text) return;

    if(state.active && state.awaitingKey){
      // ìœ„ì €ë“œì˜ â€œì§ì ‘ ì…ë ¥â€ ì±„ìš°ê¸°
      const key = state.awaitingKey;
      state.awaitingKey = null;
      userBubble(`${key}: ${text}`);
      // ìˆ«ìë§Œ ë‚¨ê¸°ë˜, ë‹¨ìœ„ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë³´ì¡´
      const pure = text.replace(/\s+/g,'');
      state.data[key] = pure;
      $input.value=''; autoGrow();
      askNext();
      return;
    }

    // ê·¸ëƒ¥ ììœ  ì§ˆë¬¸ â†’ API
    userBubble(text);
    $input.value=''; autoGrow();
    runCompute(text);
  }

  $send.addEventListener('click', sendMessage);
  $input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });
  document.getElementById('emojiBtn').addEventListener('click', ()=>{
    const arr=['ğŸ˜Š','ğŸ‘','â¤ï¸','ğŸ¤”','ğŸ’¡','ğŸ ','ğŸ”‘','ğŸ“Š']; 
    $input.value += (arr[Math.floor(Math.random()*arr.length)] || 'ğŸ˜Š');
    autoGrow(); $input.focus();
  });

  // ì‹œì‘!
  startWizard();
  </script>
</body>
</html>
