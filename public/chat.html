<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RealE - 부동산 AI 상담</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f0f23;height:100vh;overflow:hidden;color:#e5e7eb}
    .chat-container{height:100vh;display:flex;flex-direction:column;position:relative}
    .chat-messages{flex:1;overflow-y:auto;padding:32px 16px 88px}
    .messages-container{max-width:768px;margin:0 auto}
    .message{margin:12px 0;display:flex;gap:10px}
    .message.user{justify-content:flex-end}
    /* ✅ 말풍선 최소 너비 50vw 보장 + 줄바꿈 개선 */
    .message .bubble{
      display:inline-block;                 /* 내용 길이에 맞추되…   */
      max-width:80%;                        /* 컨테이너의 80%를 상한  */
      min-width:min(50vw, 80%);             /* 화면 50%를 하한(컨테이너 이내) */
      border-radius:14px;
      padding:14px 16px;
      line-height:1.6;
      overflow-wrap:anywhere;               /* 긴 숫자/URL도 줄바꿈   */
      word-break:keep-all;                  /* 한글 단어는 가급적 보존 */
    }
    .message.user .bubble{background:linear-gradient(135deg,#1f2a44,#26334f);border:1px solid #2f3b5a}
    .message.assistant .bubble{background:#1f2937;border:1px solid #374151}
    .chips{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#2a3551;border:1px solid #3a4a76;color:#e3e7ff;border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer}
    .chip:hover{background:#334065}
    .chip.alt{background:#243042;border-color:#3a4a76}
    .chip.ghost{background:transparent;border-color:#4b5563;color:#cbd5e1}
    .small{opacity:.8;font-size:13px}
    .chat-input-container{position:fixed;left:0;right:0;bottom:0;background:#1f2937;border-top:1px solid #374151;padding:14px 16px}
    .input-row{max-width:768px;margin:0 auto;display:flex;gap:12px;align-items:stretch}
    .input-wrapper{flex:1;position:relative;background:#374151;border:1px solid #4b5563;border-radius:12px;display:flex;align-items:center}
    .input-wrapper:focus-within{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.2)}
    textarea{width:100%;min-height:44px;max-height:120px;padding:12px 48px 12px 14px;border:none;border-radius:12px;background:transparent;color:#f9fafb;resize:none;outline:none;font-size:16px}
    .send-button{width:48px;border:none;border-radius:14px;background:linear-gradient(135deg,#8b5cf6,#06b6d4);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(100,116,255,.25);cursor:pointer;padding:0 0}
    .send-button:disabled{opacity:.5;cursor:not-allowed}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .typing{display:flex;gap:6px;margin-top:8px}
    .dot{width:6px;height:6px;background:#8b5cf6;border-radius:50%;opacity:.5;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <div class="messages-container" id="msgs"></div>
    </div>

    <div class="chat-input-container">
      <div class="input-row">
        <div class="input-wrapper">
          <textarea id="messageInput" placeholder="궁금한 점은 언제든 물어보세요!" rows="1"></textarea>
        </div>
        <button class="send-button" id="sendButton">
          <i class="fas fa-arrow-up"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
  /* ===== 안전 바인딩 드롭-인 패치 =====
   - DOMContentLoaded 이후 실행
   - 이벤트 위임으로 #messageInput가 나중에 생겨도 동작
   - 요소가 없어도 에러 안 나도록 방어
*/
(function () {
  // DOM 준비 후 한 번 실행
  window.addEventListener('DOMContentLoaded', initSafeBindings);

  function initSafeBindings() {
    // 1) 입력 변화 -> 버튼 활성/비활성
    document.addEventListener('input', (e) => {
      const t = e.target;
      if (!(t instanceof HTMLTextAreaElement)) return;
      if (t.id !== 'messageInput') return;

      // auto grow
      t.style.height = 'auto';
      t.style.height = Math.min(t.scrollHeight, 120) + 'px';

      const btn = document.getElementById('sendButton');
      if (btn instanceof HTMLButtonElement) {
        btn.disabled = t.value.trim() === '';
      }
    });

    // 2) Enter 전송(Shift+Enter 줄바꿈)
    document.addEventListener('keydown', (e) => {
      const t = e.target;
      if (!(t instanceof HTMLTextAreaElement)) return;
      if (t.id !== 'messageInput') return;

      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        safeSendMessage();
      }
    });

    // 3) 전송 버튼 클릭
    const btn = document.getElementById('sendButton');
    if (btn instanceof HTMLButtonElement) {
      btn.addEventListener('click', safeSendMessage);
      // 초기 버튼 상태 보정
      const ta = document.getElementById('messageInput');
      if (ta instanceof HTMLTextAreaElement) {
        btn.disabled = ta.value.trim() === '';
      }
    }
  }

  // 기존 sendMessage를 호출하되, 없으면 무시(에러 방지)
  function safeSendMessage() {
    try {
      if (typeof sendMessage === 'function') {
        sendMessage();
      } else {
        console.warn('sendMessage() 가 아직 정의되지 않았습니다.');
      }
    } catch (err) {
      console.error('sendMessage 실행 중 오류:', err);
    }
  }
})();
  // ===== 공통 유틸 =====
  const $msgs = document.getElementById('msgs');
  const $input = document.getElementById('messageInput');
  const $send = document.getElementById('sendButton');

  function scrollToBottom(){ requestAnimationFrame(()=>{ const wrap=document.getElementById('chatMessages'); wrap.scrollTop = wrap.scrollHeight; }); }
  function userBubble(html){ const el=document.createElement('div'); el.className='message user'; el.innerHTML=`<div class="bubble">${html}</div>`; $msgs.appendChild(el); scrollToBottom(); }
  function botBubble(html){ const el=document.createElement('div'); el.className='message assistant'; el.innerHTML=`<div class="bubble">${html}</div>`; $msgs.appendChild(el); scrollToBottom(); return el.querySelector('.bubble'); }
  function typingDots(parent){ const box=document.createElement('div'); box.className='typing'; box.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>'; parent.appendChild(box); return ()=>box.remove(); }

  const KR = (n)=> new Intl.NumberFormat('ko-KR',{maximumFractionDigits:0}).format(+n||0);

  // ===== API 연동 =====
  async function callApi(message){
    const res = await fetch('/api/compute',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message })
    });
    if(!res.ok){ throw new Error('API '+res.status); }
    return await res.json(); // { reply, cards, checklist, notices }
  }

  // 결과 카드 렌더(기존 함수 없으면 여기에 내장)
  function renderResult(resp){
    const wrap = document.createElement('div');
    wrap.className = 'message assistant';
    const inner = document.createElement('div');
    inner.className = 'bubble';
    let html = '';
    (resp.cards||[]).forEach(c=>{
      html += `
        <div style="background:#111827;border:1px solid #374151;border-radius:12px;padding:14px 14px;margin:10px 0;">
          <div style="font-weight:700;margin-bottom:4px">${c.title||''}</div>
          <div class="small" style="margin-bottom:8px">${c.subtitle||''}</div>
          ${c.monthly?`<div style="font-size:22px;font-weight:800;margin:4px 0">${c.monthly}</div>`:''}
          ${c.totalInterest?`<div class="small" style="margin-bottom:8px">총 이자: ${c.totalInterest}</div>`:''}
          ${Array.isArray(c.notes)?`<ul style="margin-left:16px">${c.notes.map(n=>`<li>${n}</li>`).join('')}</ul>`:''}
        </div>
      `;
    });
    if(Array.isArray(resp.checklist)&&resp.checklist.length){
      html += `
        <div style="background:#111827;border:1px solid #374151;border-radius:12px;padding:14px 14px;margin:10px 0;">
          <div style="font-weight:700;margin-bottom:8px">서류 체크리스트</div>
          <ul style="margin-left:16px">${resp.checklist.map(n=>`<li>${n}</li>`).join('')}</ul>
        </div>
      `;
    }
    if(Array.isArray(resp.notices) && resp.notices.length){
      html += `<div class="small" style="opacity:.9;margin-top:6px">${resp.notices.join(' ')}</div>`;
    }
    inner.innerHTML = html || '<div class="small">표시할 카드가 없습니다.</div>';
    wrap.appendChild(inner);
    $msgs.appendChild(wrap);
    scrollToBottom();
  }

  // ===== 대화형 위저드 =====
  const FLOW = {
    intent: { key:'의도', prompt:'어떤 상담이 필요하세요?', choices:['매매','전세','월세'] },
    steps: {
      '매매': [
        { key:'예산', unit:'억', choices:['3','4','5','6','7','8','10'] , required:true },
        { key:'보유', unit:'천', choices:['3','5','8','10','15','20'] , required:true },
        { key:'기간', unit:'년', choices:['10','20','30'] , required:true },
        { key:'상환', choices:['고정','변동','체증식'], required:false },
      ],
      '전세': [
        { key:'전세가', unit:'억', choices:['2','3','4','5','6','7','8'] , required:true },
        { key:'보유', unit:'천', choices:['1','2','3','5','8','10'] , required:true },
        { key:'기간', unit:'년', choices:['2','3','4'] , required:true },
      ],
      '월세': [
        { key:'보증금', unit:'만', choices:['100','300','500','1000','2000','3000'] , required:true },
        { key:'월세', unit:'만', choices:['40','50','60','70','80','90','120'] , required:true },
        { key:'기간', unit:'년', choices:['1','2','3'] , required:true },
      ]
    }
  };

  const state = {
    active: true,
    intent: null,
    idx: -1,
    data: {},
    awaitingKey: null, // '예산' 등 직접입력 대기
  };

  function startWizard(){
    state.active = true; state.intent = null; state.idx = -1; state.data = {}; state.awaitingKey = null;
    askIntent();
  }

  function askIntent(){
    const b = botBubble(`<div style="font-weight:700">빠르게 추천을 시작할게요.</div>
      <div class="small" style="margin-top:6px">먼저 목적을 골라 주세요.</div>`);
    renderChips(b, FLOW.intent.choices, (val)=>{
      userBubble(val);
      state.intent = val;
      askNext();
    }, { extraFree:true });
  }

  function askNext(){
    const steps = FLOW.steps[state.intent] || [];
    state.idx++;
    // 다음 필수/선호 질문이 없으면 완료
    if(state.idx >= steps.length){ return finishWizard(); }
    const step = steps[state.idx];
    const hint = step.unit ? `예: ${step.choices?.[0] ?? ''}${step.unit}` : '숫자 또는 텍스트';
    const b = botBubble(`<div style="font-weight:700">${step.key}를 선택하거나 직접 입력해 주세요.</div><div class="small" style="margin-top:6px">${hint}</div>`);
    renderChips(b, step.choices || [], (val)=>{
      const display = step.unit ? `${val}${step.unit}` : val;
      userBubble(`${step.key}: ${display}`);
      state.data[step.key] = String(val);
      askNext();
    }, { extraFree:true, key: step.key, unit: step.unit, optional: !step.required });
  }

  function finishWizard(){
    // 요약문 생성 → API 호출
    const it = state.intent;
    const d = state.data;
    let msg = it;
    const add = (k, label=k)=>{
      if(d[k]) msg += `, ${label} ${d[k]}`;
    };

    if(it==='매매'){
      add('예산'); add('보유'); add('기간'); if(d['상환']) msg += `, ${d['상환']} 선호`;
    } else if(it==='전세'){
      add('전세가'); add('보유'); add('기간');
    } else if(it==='월세'){
      // 보증금 최소 100 보정(프론트 UX)
      const dep = Math.max(100, parseInt(String(d['보증금']||'0').replace(/\D/g,'' )||'0',10));
      const rent = parseInt(String(d['월세']||'0').replace(/\D/g,'' )||'0',10);
      const years = d['기간'] || '2';
      msg = `월세, 보증금 ${dep}만, 월세 ${rent}만, ${years}년`;
    }

    userBubble(`<strong>요약</strong><br><span class="small">${msg}</span>`);
    runCompute(msg);
  }

  function renderChips(bubbleEl, choices, onPick, opts={}){
    const box = document.createElement('div'); box.className='chips';
    // 기본 선택칩
    choices.forEach(c=>{
      const btn=document.createElement('button'); btn.type='button';
      btn.className='chip'; btn.textContent=c;
      btn.onclick=()=>onPick(c);
      box.appendChild(btn);
    });
    // 직접 입력
    if(opts.extraFree){
      const free=document.createElement('button'); free.type='button';
      free.className='chip ghost'; free.textContent='직접 입력';
      free.onclick=()=>{
        state.awaitingKey = opts.key || '입력값';
        $input.placeholder = opts.unit ? `${state.awaitingKey} 입력 (예: 6${opts.unit})` : `${state.awaitingKey} 입력`;
        $input.focus();
      };
      box.appendChild(free);
    }
    // (선택) 입력 안함 — 요청하신 “이전/다음/건너뛰기 버튼”은 제거했지만,
    // 옵션 질문을 넘기고 싶을 때를 위한 아주 작은 선택지
    if(opts.optional){
      const skip=document.createElement('button'); skip.type='button';
      skip.className='chip alt'; skip.textContent='입력 안함';
      skip.onclick=()=>{ onPick(''); };
      box.appendChild(skip);
    }
    bubbleEl.appendChild(box);
    scrollToBottom();
  }

  // ===== 전송/입력 처리 =====
  function autoGrow(){
    $input.style.height='auto';
    $input.style.height=Math.min($input.scrollHeight,120)+'px';
  }
  $input.addEventListener('input', autoGrow);

  async function runCompute(summary){
    // 버튼 스피너
    const prev = $send.innerHTML;
    $send.innerHTML = '<div class="spinner"></div>';
    $send.disabled = true;

    const host = botBubble('<div class="small">계산 중입니다…</div>');
    const stop = typingDots(host);

    try{
      const resp = await callApi(summary);
      stop();
      if(resp.reply){ botBubble(resp.reply); }
      renderResult(resp);
    }catch(e){
      stop();
      botBubble('서버 오류가 발생했어요. 잠시 후 다시 시도해 주세요.');
      console.error(e);
    }finally{
      $send.innerHTML = prev;
      $send.disabled = false;
      scrollToBottom();
    }
  }

  // 사용자가 입력창으로 보낼 때:
  async function sendMessage(){
    const text = $input.value.trim();
    if(!text) return;

    if(state.active && state.awaitingKey){
      // 위저드의 “직접 입력” 채우기
      const key = state.awaitingKey;
      state.awaitingKey = null;
      userBubble(`${key}: ${text}`);
      // 숫자만 남기되, 단위가 있으면 그대로 보존
      const pure = text.replace(/\s+/g,'');
      state.data[key] = pure;
      $input.value=''; autoGrow();
      askNext();
      return;
    }

    // 그냥 자유 질문 → API
    userBubble(text);
    $input.value=''; autoGrow();
    runCompute(text);
  }

  $send.addEventListener('click', sendMessage);
  $input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });


  // 시작!
  startWizard();
  </script>
</body>
</html>
