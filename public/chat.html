<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RealE - 부동산 AI 상담</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background:#0f0f23; height:100vh; overflow:hidden; color:#e5e7eb;
    }

    .chat-container { height:100vh; display:flex; flex-direction:column; background:#0f0f23; position:relative; }
    .chat-messages { flex:1; overflow-y:auto; background:#0f0f23; padding:24px 20px 96px; }
    .messages-container { max-width:768px; margin:0 auto; padding-top:8px; }

    .message{ margin-bottom:24px; display:flex; align-items:flex-start; gap:0; }
    .message-avatar{ display:none !important; } /* 아바타 숨김 */
    .message-content{ flex:1; font-size:15px; line-height:1.6; color:#f9fafb; }
    .message.user .message-content{
      background:transparent; padding:12px 0; border-radius:0; max-width:80%;
      margin-left:auto; color:#f9fafb; text-align:right;
    }
    .message.assistant .message-content{
      background:#1f2937; padding:16px; border-radius:12px; max-width:80%; border:1px solid #374151;
    }

    .chat-input-container{
      position:fixed; bottom:0; left:0; right:0; background:#1f2937; padding:16px 20px;
      border-top:1px solid #374151; z-index:100;
    }
    .chat-input{
      display:flex; align-items:stretch; gap:12px; max-width:768px; margin:0 auto;
    }
    .input-wrapper{
      flex:1; position:relative; background:#374151; border:1px solid #4b5563; border-radius:12px;
      transition:all .2s ease; display:flex; align-items:center;
    }
    .input-wrapper:focus-within{ border-color:#8b5cf6; box-shadow:0 0 0 3px rgba(139,92,246,.2); }
    .chat-input textarea{
      width:100%; min-height:44px; max-height:120px; padding:12px 50px 12px 16px; border:none; border-radius:12px;
      resize:none; font-family:inherit; font-size:16px; line-height:1.5; outline:none; background:transparent; color:#f9fafb;
    }
    .chat-input textarea::placeholder{ color:#9ca3af; }

    .emoji-button{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      background:none; border:none; font-size:18px; cursor:pointer; color:#9ca3af; padding:4px; border-radius:4px;
    }

    .send-button{
      width:44px; height:auto; background:linear-gradient(135deg,#8b5cf6,#06b6d4);
      border:none; border-radius:12px; color:#fff; font-size:16px; cursor:pointer; transition:all .3s ease;
      display:flex; align-items:center; justify-content:center; align-self:stretch; flex-shrink:0;
      box-shadow:0 4px 15px rgba(139,92,246,.3);
    }
    .send-button:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 8px 25px rgba(139,92,246,.4); }
    .send-button:disabled{ background:#4b5563; cursor:not-allowed; transform:none; box-shadow:none; }
    .send-button i{ display:inline-flex; align-items:center; justify-content:center; line-height:1; vertical-align:middle; height:1em; width:1em; transform:translateY(1px); }

    .typing-indicator{ display:none; padding:0 16px 16px; }
    .typing-container{ max-width:768px; margin:0 auto; display:flex; align-items:flex-start; gap:0; }
    .typing-bubble{ background:#1f2937; border:1px solid #374151; padding:12px 16px; border-radius:12px; display:flex; align-items:center; gap:4px; }
    .typing-dots{ display:flex; gap:4px; }
    .typing-dots span{ width:6px; height:6px; background:#8b5cf6; border-radius:50%; animation:typing 1.4s infinite; }
    .typing-dots span:nth-child(2){ animation-delay:.2s; }
    .typing-dots span:nth-child(3){ animation-delay:.4s; }
    @keyframes typing{ 0%,60%,100%{ transform:translateY(0); opacity:.4; } 30%{ transform:translateY(-6px); opacity:1; } }

    .chat-messages::-webkit-scrollbar{ width:6px; } .chat-messages::-webkit-scrollbar-track{ background:transparent; }
    .chat-messages::-webkit-scrollbar-thumb{ background:rgba(156,163,175,.5); border-radius:3px; }
    .chat-messages::-webkit-scrollbar-thumb:hover{ background:rgba(156,163,175,.7); }

    /* ---------------- Guided chips UI ---------------- */
    .guided-wrap { max-width:768px; margin:0 auto 12px; }
    .guide-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .guide-title { font-weight:600; font-size:16px; color:#e5e7eb; }
    .guide-sub { color:#9ca3af; font-size:13px; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip {
      background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:10px 14px; border-radius:999px;
      cursor:pointer; font-size:14px; transition:.15s; user-select:none;
    }
    .chip:hover { border-color:#6366f1; }
    .chip.active { background:#2b3560; border-color:#6366f1; }
    .guide-ctrls { display:flex; gap:8px; margin-top:12px; }
    .btn {
      background:#2b2f43; color:#e5e7eb; border:1px solid #3b405c; padding:10px 12px; border-radius:10px; font-size:14px;
      cursor:pointer;
    }
    .btn.primary { background:linear-gradient(135deg,#8b5cf6,#06b6d4); border:none; color:#fff; }
    .summary-pill { margin-top:12px; background:#111827; border:1px solid #374151; border-radius:12px; padding:10px 12px; color:#9ca3af; font-size:13px; }
    .link { color:#93c5fd; cursor:pointer; text-decoration:underline; margin-left:6px; }

    /* 결과 카드 */
    .result-cards{ max-width:768px; margin:16px auto 0; display:grid; gap:12px; }
    .result-card{ background:#1f2937; border:1px solid #374151; border-radius:12px; padding:16px; color:#f9fafb; }
    .result-card .title{ font-weight:600; }
    .result-card .sub{ color:#9ca3af; font-size:14px; }
    .result-card .big{ margin-top:8px; font-size:18px; }
    .result-card ul{ margin-top:8px; padding-left:18px; }
    .share-box{ margin-top:12px; display:flex; gap:8px; align-items:center; }
    .share-input{ flex:1; padding:8px; border-radius:8px; border:1px solid #4b5563; background:#111827; color:#e5e7eb; }
  /* send button spinner toggle */
    .send-button .icon-arrow { display:inline-flex; }
    .send-button .icon-spinner { display:none; }
    .send-button.loading .icon-arrow { display:none; }
    .send-button.loading .icon-spinner { display:inline-flex; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <!-- Guided chips UI -->
      <div class="guided-wrap" id="guided">
        <div class="guide-head">
          <div class="guide-title">빠른 추천을 위한 선택</div>
          <div class="guide-sub"><span id="stepNum">1</span>/<span id="stepTotal">8</span></div>
        </div>

        <div class="summary-pill" id="summary">선택값이 여기에 요약됩니다.</div>
        <div class="chips" id="chips"></div>

        <div class="guide-ctrls">
          <button class="btn" id="prevBtn" disabled>이전</button>
          <button class="btn" id="skipBtn">건너뛰기</button>
          <button class="btn primary" id="nextBtn">다음</button>
          <span class="link" id="freeInputLink" title="자유 입력으로 전환">직접 입력할래요</span>
        </div>
      </div>

      <div class="messages-container" id="msgMount"></div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-container">
        <div class="typing-bubble">
          <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input">
        <div class="input-wrapper">
          <textarea id="messageInput" placeholder="(선택 완료 후에도) 자유롭게 물어보세요" rows="1" maxlength="2000"></textarea>
          <button class="emoji-button" onclick="toggleEmoji()">😊</button>
        </div>
      <button class="send-button" id="sendButton" onclick="sendMessage()">
        <i class="fas fa-arrow-up fa-fw icon-arrow"></i>
        <i class="fas fa-spinner fa-spin fa-fw icon-spinner" aria-hidden="true"></i>
      </button>
      </div>
    </div>
  </div>

  <script>
    // ---------- 기존 공통 ----------
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const msgMount = document.getElementById('msgMount');

    messageInput.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      sendButton.disabled = this.value.trim() === '';
    });
    messageInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    function addMessage(message, sender) {
      const container = msgMount;
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.innerHTML = `<div class="message-avatar"></div><div class="message-content">${message.replace(/\n/g,'<br>')}</div>`;
      container.appendChild(div); scrollToBottom();
    }
    function createMessagesContainer(){ return msgMount; }
    function showTyping(){ typingIndicator.style.display='block'; scrollToBottom(); }
    function hideTyping(){ typingIndicator.style.display='none'; }
    function scrollToBottom(){ setTimeout(()=>{ chatMessages.scrollTop = chatMessages.scrollHeight; }, 50); }
    function toggleEmoji(){
      const emojis = ['😊','👍','❤️','🤔','💡','🏠','🔑','📊'];
      const e = emojis[Math.floor(Math.random()*emojis.length)];
      messageInput.value += e; messageInput.focus();
      sendButton.disabled = messageInput.value.trim()==='';
    }

    async function callApi(userMessage) {
      const res = await fetch('/api/compute', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ message: userMessage })
      });
      if(!res.ok) throw new Error('API ' + res.status);
      return await res.json(); // { reply, cards, checklist, share_url }
    }

    function renderResult(resp){
      const wrap = document.createElement('div');
      wrap.className = 'result-cards';

      (resp.cards || []).forEach(c => {
        const el = document.createElement('div');
        el.className = 'result-card';
        el.innerHTML = `
          <div class="title">${c.title}</div>
          ${c.subtitle ? `<div class="sub">${c.subtitle}</div>` : ''}
          ${c.monthly ? `<div class="big">${c.monthly}</div>` : ''}
          ${c.totalInterest ? `<div>${c.totalInterest}</div>` : ''}
          ${Array.isArray(c.notes) ? `<ul>${c.notes.map(n=>`<li>${n}</li>`).join('')}</ul>` : ''}
        `;
        wrap.appendChild(el);
      });

      if (Array.isArray(resp.checklist) && resp.checklist.length){
        const el = document.createElement('div');
        el.className = 'result-card';
        el.innerHTML = `
          <div class="title">서류 체크리스트</div>
          <ul>${resp.checklist.map(n=>`<li>${n}</li>`).join('')}</ul>
        `;
        wrap.appendChild(el);
      }

      if (resp.share_url){
        const el = document.createElement('div');
        el.className = 'result-card';
        const full = location.origin + resp.share_url;
        el.innerHTML = `
          <div class="title">공유</div>
          <div class="share-box">
            <input class="share-input" value="${full}" readonly />
            <button class="chip" onclick="navigator.clipboard.writeText('${full}')">복사</button>
            <a class="chip" style="text-decoration:none" href="${full}" target="_blank">열기</a>
          </div>
        `;
        wrap.appendChild(el);
      }

      msgMount.appendChild(wrap); scrollToBottom();
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      messageInput.value = ''; messageInput.style.height='auto'; sendButton.disabled = true;
      showTyping();
      try{
        const resp = await callApi(text);
        hideTyping(); renderResult(resp);
        addMessage(resp.reply || '요약', 'assistant');
      }catch(e){ hideTyping(); addMessage('서버 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.', 'assistant'); }
    }

    // ---------- Guided chips logic ----------
    const guidedEl = document.getElementById('guided');
    const chipsEl = document.getElementById('chips');
    const stepNumEl = document.getElementById('stepNum');
    const stepTotalEl = document.getElementById('stepTotal');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const freeInputLink = document.getElementById('freeInputLink');
    const summaryEl = document.getElementById('summary');

    const STEPS = [
      { key:'type',   title:'무엇을 하실 건가요?', opts:['매매','전세','월세'] },
      { key:'budget', title:'예산은 어느 정도인가요?', opts:['3억','4억','5억','6억','7억','8억','10억+','직접 입력'] },
      { key:'cash',   title:'보유 자금(현금/전세보증금)은?', opts:['2천','4천','6천','8천','1억','2억+','직접 입력'] },
      { key:'income', title:'연소득(개인/부부 합산)은?', opts:['3천','4천','5천','6천','7천','1억+','직접 입력'] },
      { key:'tenure', title:'재직 기간은?', opts:['6개월','10개월','1년','2년+','직접 입력'] },
      { key:'region', title:'지역은 어디인가요?', opts:['서울','경기','인천','수도권','지방(광역)','기타','직접 입력'] },
      { key:'term',   title:'대출 기간은?', opts:['20년','25년','30년','40년'] },
      { key:'repay',  title:'상환 방식은?', opts:['체증식','원리금균등','만기일시'] },
    ];
    stepTotalEl.textContent = STEPS.length;

    const S = { type:'', budget:'', cash:'', income:'', tenure:'', region:'', term:'', repay:'' };
    let idx = 0;

    function renderStep(){
      const cur = STEPS[idx];
      stepNumEl.textContent = (idx+1);
      summaryEl.textContent = buildSummary(true);
      chipsEl.innerHTML = '';
      cur.opts.forEach(op=>{
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = op;
        b.onclick = async ()=>{
          let val = op;
          if(op.includes('직접 입력')){
            const v = prompt(`${cur.title} (예: 6억 / 8500 / 서울 등)`);
            if(!v) return; val = v.trim();
          }
          S[cur.key] = val;
          renderStep(); // active 반영
        };
        if(S[cur.key] && (S[cur.key]===op)) b.classList.add('active');
        chipsEl.appendChild(b);
      });

      prevBtn.disabled = idx===0;
      nextBtn.textContent = idx===STEPS.length-1 ? '완료' : '다음';
    }

    function buildSummary(brief=false){
      const parts = [];
      if(S.type)   parts.push(S.type);
      if(S.budget) parts.push(`예산 ${S.budget}`);
      if(S.cash)   parts.push(`보유 ${S.cash}`);
      if(S.income) parts.push(`연소득 ${S.income}`);
      if(S.tenure) parts.push(`재직 ${S.tenure}`);
      if(S.region) parts.push(S.region);
      if(S.term)   parts.push(S.term);
      if(S.repay)  parts.push(`${S.repay} 선호`);
      if(parts.length===0) return '선택값이 여기에 요약됩니다.';
      return brief ? parts.join(' · ') : parts.join(', ');
    }

    prevBtn.onclick = ()=>{ if(idx>0){ idx--; renderStep(); } };
    skipBtn.onclick = ()=>{ idx = Math.min(idx+1, STEPS.length-1); renderStep(); };
    nextBtn.onclick = async ()=>{
      // 값 없으면 넘어가기
      if(!S[STEPS[idx].key]) { idx = Math.min(idx+1, STEPS.length-1); renderStep(); return; }
      if(idx < STEPS.length-1){ idx++; renderStep(); return; }

      // 완료 → 문장 생성 → API
      const text = buildSummary(false);
      guidedEl.style.display='none';
      addMessage(text, 'user');
      showTyping();
      try{
        const resp = await callApi(text);
        hideTyping(); renderResult(resp);
        addMessage(resp.reply || '요약', 'assistant');
      }catch(e){
        hideTyping(); addMessage('서버 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.', 'assistant');
      }
    };

    freeInputLink.onclick = ()=>{ guidedEl.style.display='none'; };

    // init
    renderStep();
  </script>
</body>
</html>
